<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UniversalDiffApp.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Universal Difference Checker</a> &gt; <a href="index.source.html" class="el_package">com.universaldiff.app</a> &gt; <span class="el_source">UniversalDiffApp.java</span></div><h1>UniversalDiffApp.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">package com.universaldiff.app;</span>

import com.universaldiff.core.model.ComparisonSession;
import com.universaldiff.core.model.DiffHunk;
import com.universaldiff.core.model.FormatType;
import com.universaldiff.core.model.MergeChoice;
import com.universaldiff.core.model.MergeDecision;
import com.universaldiff.ui.viewmodel.DiffViewModel;
import javafx.application.Application;
import javafx.collections.ListChangeListener;
import javafx.geometry.Orientation;
import javafx.scene.Scene;
import javafx.scene.control.Alert;
import javafx.scene.control.Button;
import javafx.scene.control.CheckBox;
import javafx.scene.control.ComboBox;
import javafx.scene.control.Label;
import javafx.scene.control.ScrollPane;
import javafx.scene.control.SplitPane;
import javafx.scene.control.ToolBar;
import javafx.scene.layout.BorderPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.Priority;
import javafx.scene.layout.VBox;
import javafx.scene.text.Text;
import javafx.scene.text.TextFlow;
import javafx.stage.FileChooser;
import javafx.stage.Stage;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.nio.charset.Charset;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;

<span class="nc" id="L41">public class UniversalDiffApp extends Application {</span>

<span class="nc" id="L43">    private static final Logger log = LoggerFactory.getLogger(UniversalDiffApp.class);</span>

    private static final int BINARY_BYTES_PER_LINE = 16;
    private static final int TEXT_RENDER_LIMIT = 200_000;
<span class="nc" id="L47">    private static final int BINARY_RENDER_LIMIT = 131_072;</span>

<span class="nc" id="L49">    private final DiffViewModel viewModel = new DiffViewModel();</span>

    private VBox leftColumn;
    private VBox rightColumn;

    @Override
    public void start(Stage stage) {
<span class="nc" id="L56">        stage.setTitle(&quot;Universal Difference Checker&quot;);</span>

<span class="nc" id="L58">        leftColumn = createDiffColumn(&quot;Left&quot;);</span>
<span class="nc" id="L59">        rightColumn = createDiffColumn(&quot;Right&quot;);</span>

<span class="nc" id="L61">        viewModel.hunksProperty().addListener((ListChangeListener&lt;? super DiffHunk&gt;) change -&gt; renderDiffColumns());</span>

<span class="nc" id="L63">        BorderPane root = new BorderPane();</span>
<span class="nc" id="L64">        root.setTop(createToolbar(stage));</span>
<span class="nc" id="L65">        root.setCenter(createContent());</span>

<span class="nc" id="L67">        Scene scene = new Scene(root, 1100, 750);</span>
<span class="nc" id="L68">        scene.getStylesheets().add(getClass().getResource(&quot;/com/universaldiff/ui/udc.css&quot;).toExternalForm());</span>
<span class="nc" id="L69">        stage.setScene(scene);</span>
<span class="nc" id="L70">        stage.show();</span>

<span class="nc" id="L72">        renderDiffColumns();</span>
<span class="nc" id="L73">    }</span>

    private ToolBar createToolbar(Stage stage) {
<span class="nc" id="L76">        Button openLeft = new Button(&quot;Open Left&quot;);</span>
<span class="nc" id="L77">        openLeft.setOnAction(e -&gt; chooseFile(stage, true));</span>
<span class="nc" id="L78">        Button openRight = new Button(&quot;Open Right&quot;);</span>
<span class="nc" id="L79">        openRight.setOnAction(e -&gt; chooseFile(stage, false));</span>

<span class="nc" id="L81">        Button compareButton = new Button(&quot;Compare&quot;);</span>
<span class="nc" id="L82">        compareButton.setOnAction(e -&gt; runComparison());</span>

<span class="nc" id="L84">        CheckBox ignoreJsonCheck = new CheckBox(&quot;Ignore JSON key order&quot;);</span>
<span class="nc" id="L85">        ignoreJsonCheck.selectedProperty().bindBidirectional(viewModel.ignoreJsonKeyOrderProperty());</span>

<span class="nc" id="L87">        ComboBox&lt;MergeChoice&gt; mergeStrategy = new ComboBox&lt;&gt;();</span>
<span class="nc" id="L88">        mergeStrategy.getItems().addAll(MergeChoice.TAKE_LEFT, MergeChoice.TAKE_RIGHT, MergeChoice.MANUAL);</span>
<span class="nc" id="L89">        mergeStrategy.getSelectionModel().select(MergeChoice.TAKE_RIGHT);</span>

<span class="nc" id="L91">        Button mergeButton = new Button(&quot;Merge&quot;);</span>
<span class="nc" id="L92">        mergeButton.setOnAction(e -&gt; runMerge(stage, mergeStrategy.getValue()));</span>

<span class="nc" id="L94">        return new ToolBar(openLeft, openRight, compareButton, new Label(&quot;Merge strategy:&quot;), mergeStrategy, mergeButton, ignoreJsonCheck);</span>
    }

    private SplitPane createContent() {
<span class="nc" id="L98">        SplitPane splitPane = new SplitPane();</span>
<span class="nc" id="L99">        splitPane.setOrientation(Orientation.HORIZONTAL);</span>

<span class="nc" id="L101">        ScrollPane leftScroll = wrapColumn(leftColumn);</span>
<span class="nc" id="L102">        ScrollPane rightScroll = wrapColumn(rightColumn);</span>

<span class="nc" id="L104">        VBox leftPane = new VBox(leftScroll);</span>
<span class="nc" id="L105">        VBox rightPane = new VBox(rightScroll);</span>
<span class="nc" id="L106">        VBox.setVgrow(leftScroll, Priority.ALWAYS);</span>
<span class="nc" id="L107">        VBox.setVgrow(rightScroll, Priority.ALWAYS);</span>

<span class="nc" id="L109">        splitPane.getItems().addAll(leftPane, rightPane);</span>
<span class="nc" id="L110">        splitPane.setDividerPositions(0.5);</span>
<span class="nc" id="L111">        return splitPane;</span>
    }

    private ScrollPane wrapColumn(VBox column) {
<span class="nc" id="L115">        ScrollPane scroll = new ScrollPane(column);</span>
<span class="nc" id="L116">        scroll.setFitToWidth(true);</span>
<span class="nc" id="L117">        scroll.getStyleClass().add(&quot;diff-column-scroll&quot;);</span>
<span class="nc" id="L118">        return scroll;</span>
    }

    private VBox createDiffColumn(String title) {
<span class="nc" id="L122">        VBox column = new VBox();</span>
<span class="nc" id="L123">        column.getStyleClass().add(&quot;diff-column&quot;);</span>
<span class="nc" id="L124">        column.getChildren().add(createColumnHeader(title));</span>
<span class="nc" id="L125">        return column;</span>
    }

    private Label createColumnHeader(String title) {
<span class="nc" id="L129">        Label header = new Label(title);</span>
<span class="nc" id="L130">        header.getStyleClass().add(&quot;diff-column-header&quot;);</span>
<span class="nc" id="L131">        return header;</span>
    }

    private void chooseFile(Stage stage, boolean isLeft) {
<span class="nc" id="L135">        FileChooser chooser = new FileChooser();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">        Path initial = isLeft ? viewModel.leftPathProperty().get() : viewModel.rightPathProperty().get();</span>
<span class="nc bnc" id="L137" title="All 4 branches missed.">        if (initial != null &amp;&amp; initial.getParent() != null) {</span>
<span class="nc" id="L138">            chooser.setInitialDirectory(initial.getParent().toFile());</span>
        }
<span class="nc" id="L140">        var chosen = chooser.showOpenDialog(stage);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (chosen != null) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (isLeft) {</span>
<span class="nc" id="L143">                viewModel.leftPathProperty().set(chosen.toPath());</span>
<span class="nc" id="L144">            } else {</span>
<span class="nc" id="L145">                viewModel.rightPathProperty().set(chosen.toPath());</span>
            }
<span class="nc" id="L147">            renderDiffColumns();</span>
        }
<span class="nc" id="L149">    }</span>

    private void runComparison() {
        try {
<span class="nc" id="L153">            viewModel.compare();</span>
<span class="nc" id="L154">            renderDiffColumns();</span>
<span class="nc" id="L155">        } catch (IOException ex) {</span>
<span class="nc" id="L156">            log.error(&quot;Comparison failed while reading files {} and {}&quot;,</span>
<span class="nc" id="L157">                    viewModel.leftPathProperty().get(), viewModel.rightPathProperty().get(), ex);</span>
<span class="nc" id="L158">            showError(&quot;Comparison failed&quot;, ex);</span>
        }
<span class="nc" id="L160">    }</span>

    private void runMerge(Stage stage, MergeChoice choice) {
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (viewModel.getCurrentSession().isEmpty()) {</span>
<span class="nc" id="L164">            showError(&quot;Merge error&quot;, new IllegalStateException(&quot;Run a comparison first.&quot;));</span>
<span class="nc" id="L165">            return;</span>
        }
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (choice == MergeChoice.MANUAL) {</span>
<span class="nc" id="L168">            showError(&quot;Merge error&quot;, new UnsupportedOperationException(&quot;Manual merge decisions via UI not implemented yet.&quot;));</span>
<span class="nc" id="L169">            return;</span>
        }
<span class="nc" id="L171">        FileChooser chooser = new FileChooser();</span>
<span class="nc" id="L172">        chooser.setInitialFileName(&quot;merged-output&quot; + determineExtension());</span>
<span class="nc" id="L173">        var target = chooser.showSaveDialog(stage);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (target == null) {</span>
<span class="nc" id="L175">            return;</span>
        }
<span class="nc" id="L177">        List&lt;MergeDecision&gt; decisions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        for (DiffHunk hunk : viewModel.hunksProperty()) {</span>
<span class="nc" id="L179">            decisions.add(new MergeDecision(hunk.getId(), choice, null));</span>
        }
        try {
<span class="nc" id="L182">            viewModel.merge(decisions, target.toPath());</span>
<span class="nc" id="L183">            showInfo(&quot;Merge completed&quot;, &quot;Merged output saved to &quot; + target.toPath());</span>
<span class="nc" id="L184">        } catch (IOException ex) {</span>
<span class="nc" id="L185">            log.error(&quot;Merge failed writing to {}&quot;, target.toPath(), ex);</span>
<span class="nc" id="L186">            showError(&quot;Merge failed&quot;, ex);</span>
        }
<span class="nc" id="L188">    }</span>

    private void renderDiffColumns() {
<span class="nc" id="L191">        resetColumn(leftColumn, &quot;Left&quot;);</span>
<span class="nc" id="L192">        resetColumn(rightColumn, &quot;Right&quot;);</span>

<span class="nc" id="L194">        Optional&lt;ComparisonSession&gt; sessionOpt = viewModel.getCurrentSession();</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (sessionOpt.isEmpty()) {</span>
<span class="nc" id="L196">            return;</span>
        }

        try {
<span class="nc" id="L200">            ComparisonSession session = sessionOpt.get();</span>
<span class="nc" id="L201">            FormatType formatType = session.getLeft().getFormatType();</span>
<span class="nc" id="L202">            boolean isBinary = isBinaryFormat(formatType);</span>

<span class="nc bnc" id="L204" title="All 2 branches missed.">            if (isBinary) {</span>
<span class="nc" id="L205">                byte[] leftBytes = Files.readAllBytes(session.getLeft().getPath());</span>
<span class="nc" id="L206">                byte[] rightBytes = Files.readAllBytes(session.getRight().getPath());</span>

<span class="nc" id="L208">                populateBinaryColumn(leftColumn, buildBinaryLines(leftBytes, rightBytes), true);</span>
<span class="nc" id="L209">                populateBinaryColumn(rightColumn, buildBinaryLines(rightBytes, leftBytes), false);</span>
<span class="nc" id="L210">            } else {</span>
<span class="nc" id="L211">                String leftText = String.join(&quot;\n&quot;, session.getLeftContent().getLogicalRecords());</span>
<span class="nc" id="L212">                String rightText = String.join(&quot;\n&quot;, session.getRightContent().getLogicalRecords());</span>

<span class="nc bnc" id="L214" title="All 2 branches missed.">                boolean leftTruncated = leftText.length() &gt; TEXT_RENDER_LIMIT;</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                boolean rightTruncated = rightText.length() &gt; TEXT_RENDER_LIMIT;</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                String leftShown = leftTruncated ? leftText.substring(0, TEXT_RENDER_LIMIT) : leftText;</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">                String rightShown = rightTruncated ? rightText.substring(0, TEXT_RENDER_LIMIT) : rightText;</span>

<span class="nc" id="L219">                populateTextColumn(leftColumn, buildTextLines(leftShown, rightShown), &quot;diff-delta-left&quot;, &quot;diff-row-left&quot;);</span>
<span class="nc" id="L220">                populateTextColumn(rightColumn, buildTextLines(rightShown, leftShown), &quot;diff-delta-right&quot;, &quot;diff-row-right&quot;);</span>

<span class="nc bnc" id="L222" title="All 2 branches missed.">                if (leftTruncated) {</span>
<span class="nc" id="L223">                    addTruncationNotice(leftColumn, false, leftText.length(), leftShown.length());</span>
                }
<span class="nc bnc" id="L225" title="All 2 branches missed.">                if (rightTruncated) {</span>
<span class="nc" id="L226">                    addTruncationNotice(rightColumn, false, rightText.length(), rightShown.length());</span>
                }
            }
<span class="nc" id="L229">        } catch (IOException ex) {</span>
<span class="nc" id="L230">            log.error(&quot;Failed to render diff columns&quot;, ex);</span>
<span class="nc" id="L231">            showError(&quot;Render error&quot;, ex);</span>
        }
<span class="nc" id="L233">    }</span>

    private boolean isBinaryFormat(FormatType formatType) {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        return switch (formatType) {</span>
<span class="nc" id="L237">            case BIN, HEX -&gt; true;</span>
<span class="nc" id="L238">            default -&gt; false;</span>
        };
    }

    private String readText(Path path, Charset charset) throws IOException {
<span class="nc" id="L243">        return Files.readString(path, charset);</span>
    }

    private void populateTextColumn(VBox column,
                                    List&lt;TextLine&gt; lines,
                                    String diffClass,
                                    String rowClass) {
<span class="nc bnc" id="L250" title="All 2 branches missed.">        for (TextLine line : lines) {</span>
<span class="nc" id="L251">            HBox row = new HBox();</span>
<span class="nc" id="L252">            row.getStyleClass().add(&quot;diff-row&quot;);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">            boolean hasDiff = line.segments().stream().anyMatch(segment -&gt; segment.type() == SegmentType.DIFF);</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">            if (hasDiff) {</span>
<span class="nc" id="L255">                row.getStyleClass().add(rowClass);</span>
<span class="nc" id="L256">            } else {</span>
<span class="nc" id="L257">                row.getStyleClass().add(&quot;diff-row-neutral&quot;);</span>
            }

<span class="nc" id="L260">            Label number = new Label(String.valueOf(line.number()));</span>
<span class="nc" id="L261">            number.getStyleClass().add(&quot;diff-line-number&quot;);</span>

<span class="nc" id="L263">            TextFlow flow = new TextFlow();</span>
<span class="nc" id="L264">            flow.getStyleClass().add(&quot;diff-text-flow&quot;);</span>

<span class="nc bnc" id="L266" title="All 2 branches missed.">            if (line.segments().isEmpty()) {</span>
<span class="nc" id="L267">                flow.getChildren().add(new Text(&quot;&quot;));</span>
<span class="nc" id="L268">            } else {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">                for (Segment segment : line.segments()) {</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">                    if (segment.type() == SegmentType.DIFF) {</span>
<span class="nc" id="L271">                        Label highlight = new Label(segment.text());</span>
<span class="nc" id="L272">                        highlight.getStyleClass().addAll(&quot;diff-text-highlight&quot;, diffClass);</span>
<span class="nc" id="L273">                        flow.getChildren().add(highlight);</span>
<span class="nc" id="L274">                    } else {</span>
<span class="nc" id="L275">                        Text text = new Text(segment.text());</span>
<span class="nc" id="L276">                        text.getStyleClass().add(&quot;diff-text-normal&quot;);</span>
<span class="nc" id="L277">                        flow.getChildren().add(text);</span>
                    }
                }
            }

<span class="nc" id="L282">            row.getChildren().addAll(number, flow);</span>
<span class="nc" id="L283">            column.getChildren().add(row);</span>
        }
<span class="nc" id="L285">    }</span>

    private List&lt;TextLine&gt; buildTextLines(String content, String counterpart) {
<span class="nc" id="L288">        List&lt;TextLine&gt; lines = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (content == null) {</span>
<span class="nc" id="L290">            lines.add(new TextLine(1, List.of()));</span>
<span class="nc" id="L291">            return lines;</span>
        }

<span class="nc" id="L294">        int len = content.length();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">        int otherLen = counterpart == null ? 0 : counterpart.length();</span>

<span class="nc" id="L297">        List&lt;Segment&gt; currentSegments = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L298">        SegmentType currentType = null;</span>
<span class="nc" id="L299">        StringBuilder buffer = new StringBuilder();</span>
<span class="nc" id="L300">        int lineNumber = 1;</span>

<span class="nc bnc" id="L302" title="All 2 branches missed.">        for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L303">            char ch = content.charAt(i);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">            if (ch == '\r') {</span>
<span class="nc" id="L305">                continue;</span>
            }
<span class="nc bnc" id="L307" title="All 2 branches missed.">            if (ch == '\n') {</span>
<span class="nc" id="L308">                flushSegment(currentSegments, buffer, currentType);</span>
<span class="nc" id="L309">                lines.add(new TextLine(lineNumber++, List.copyOf(currentSegments)));</span>
<span class="nc" id="L310">                currentSegments.clear();</span>
<span class="nc" id="L311">                currentType = null;</span>
<span class="nc" id="L312">                continue;</span>
            }

<span class="nc bnc" id="L315" title="All 4 branches missed.">            boolean match = i &lt; otherLen &amp;&amp; counterpart.charAt(i) == ch;</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            SegmentType type = match ? SegmentType.MATCH : SegmentType.DIFF;</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">            if (type != currentType) {</span>
<span class="nc" id="L318">                flushSegment(currentSegments, buffer, currentType);</span>
<span class="nc" id="L319">                currentType = type;</span>
            }
<span class="nc" id="L321">            buffer.append(ch);</span>
        }

<span class="nc" id="L324">        flushSegment(currentSegments, buffer, currentType);</span>
<span class="nc" id="L325">        lines.add(new TextLine(lineNumber, List.copyOf(currentSegments)));</span>
<span class="nc" id="L326">        return lines;</span>
    }

    private void populateBinaryColumn(VBox column,
                                      List&lt;BinaryLine&gt; lines,
                                      boolean isLeftColumn) {
<span class="nc bnc" id="L332" title="All 2 branches missed.">        for (BinaryLine line : lines) {</span>
<span class="nc" id="L333">            HBox row = new HBox();</span>
<span class="nc" id="L334">            row.getStyleClass().add(&quot;diff-row&quot;);</span>
<span class="nc" id="L335">            boolean hasDiff = line.cells().stream().anyMatch(BinaryCell::diff);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">            if (hasDiff) {</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                row.getStyleClass().add(isLeftColumn ? &quot;binary-row-left&quot; : &quot;binary-row-right&quot;);</span>
<span class="nc" id="L338">            } else {</span>
<span class="nc" id="L339">                row.getStyleClass().add(&quot;binary-row-neutral&quot;);</span>
            }

<span class="nc" id="L342">            Label offsetLabel = new Label(String.format(&quot;%08X&quot;, line.offset()));</span>
<span class="nc" id="L343">            offsetLabel.getStyleClass().add(&quot;binary-offset&quot;);</span>

<span class="nc" id="L345">            TextFlow hexFlow = new TextFlow();</span>
<span class="nc" id="L346">            hexFlow.getStyleClass().add(&quot;binary-hex-flow&quot;);</span>

<span class="nc" id="L348">            TextFlow asciiFlow = new TextFlow();</span>
<span class="nc" id="L349">            asciiFlow.getStyleClass().add(&quot;binary-ascii-flow&quot;);</span>

<span class="nc bnc" id="L351" title="All 2 branches missed.">            for (BinaryCell cell : line.cells()) {</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                if (!cell.present()) {</span>
<span class="nc" id="L353">                    Label hexPlaceholder = new Label(&quot;  &quot;);</span>
<span class="nc" id="L354">                    hexPlaceholder.getStyleClass().add(&quot;binary-hex-byte&quot;);</span>
<span class="nc" id="L355">                    hexFlow.getChildren().add(hexPlaceholder);</span>

<span class="nc" id="L357">                    Label asciiPlaceholder = new Label(&quot; &quot;);</span>
<span class="nc" id="L358">                    asciiPlaceholder.getStyleClass().add(&quot;binary-ascii-char&quot;);</span>
<span class="nc" id="L359">                    asciiFlow.getChildren().add(asciiPlaceholder);</span>
<span class="nc" id="L360">                    continue;</span>
                }

<span class="nc" id="L363">                Label hexLabel = new Label(cell.hex());</span>
<span class="nc" id="L364">                hexLabel.getStyleClass().add(&quot;binary-hex-byte&quot;);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">                if (cell.diff()) {</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                    hexLabel.getStyleClass().add(isLeftColumn ? &quot;binary-hex-byte-diff-left&quot; : &quot;binary-hex-byte-diff-right&quot;);</span>
                }
<span class="nc" id="L368">                hexFlow.getChildren().add(hexLabel);</span>

<span class="nc" id="L370">                Label asciiLabel = new Label(String.valueOf(cell.ascii()));</span>
<span class="nc" id="L371">                asciiLabel.getStyleClass().add(&quot;binary-ascii-char&quot;);</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">                if (cell.diff()) {</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                    asciiLabel.getStyleClass().add(isLeftColumn ? &quot;binary-ascii-char-diff-left&quot; : &quot;binary-ascii-char-diff-right&quot;);</span>
                }
<span class="nc" id="L375">                asciiFlow.getChildren().add(asciiLabel);</span>
            }

<span class="nc" id="L378">            row.getChildren().addAll(offsetLabel, hexFlow, asciiFlow);</span>
<span class="nc" id="L379">            column.getChildren().add(row);</span>
        }
<span class="nc" id="L381">    }</span>

    private List&lt;BinaryLine&gt; buildBinaryLines(byte[] content, byte[] counterpart) {
<span class="nc" id="L384">        List&lt;BinaryLine&gt; lines = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L385">        int maxLength = Math.max(content.length, counterpart.length);</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">        for (int base = 0; base &lt; maxLength; base += BINARY_BYTES_PER_LINE) {</span>
<span class="nc" id="L387">            List&lt;BinaryCell&gt; cells = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">            for (int i = 0; i &lt; BINARY_BYTES_PER_LINE; i++) {</span>
<span class="nc" id="L389">                int index = base + i;</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">                if (index &lt; content.length) {</span>
<span class="nc" id="L391">                    int value = content[index] &amp; 0xFF;</span>
<span class="nc bnc" id="L392" title="All 4 branches missed.">                    boolean diff = index &gt;= counterpart.length || content[index] != counterpart[index];</span>
<span class="nc" id="L393">                    String hex = String.format(&quot;%02X&quot;, value);</span>
<span class="nc bnc" id="L394" title="All 4 branches missed.">                    char ascii = value &gt;= 32 &amp;&amp; value &lt;= 126 ? (char) value : '.';</span>
<span class="nc" id="L395">                    cells.add(new BinaryCell(index, hex, ascii, diff, true));</span>
<span class="nc" id="L396">                } else {</span>
<span class="nc" id="L397">                    cells.add(new BinaryCell(index, &quot;  &quot;, ' ', false, false));</span>
                }
            }
<span class="nc" id="L400">            lines.add(new BinaryLine(base, cells));</span>
        }
<span class="nc bnc" id="L402" title="All 2 branches missed.">        if (lines.isEmpty()) {</span>
<span class="nc" id="L403">            lines.add(new BinaryLine(0, List.of()))</span>
            ;
        }
<span class="nc" id="L406">        return lines;</span>
    }


    private void addTruncationNotice(VBox column, boolean binary, long totalLength, long shownLength) {
<span class="nc" id="L411">        HBox row = new HBox();</span>
<span class="nc" id="L412">        row.getStyleClass().addAll(&quot;diff-row&quot;, &quot;truncated-row&quot;);</span>

<span class="nc" id="L414">        Label marker = new Label(&quot;\u2026&quot;);</span>
<span class="nc" id="L415">        marker.getStyleClass().add(&quot;diff-line-number&quot;);</span>

<span class="nc bnc" id="L417" title="All 2 branches missed.">        String unit = binary ? &quot;bytes&quot; : &quot;characters&quot;;</span>
<span class="nc" id="L418">        String messageText = String.format(&quot;Showing first %,d of %,d %s (truncated for performance).&quot;,</span>
<span class="nc" id="L419">                shownLength, totalLength, unit);</span>
<span class="nc" id="L420">        Label message = new Label(messageText);</span>
<span class="nc" id="L421">        message.getStyleClass().add(&quot;truncated-message&quot;);</span>

<span class="nc" id="L423">        row.getChildren().addAll(marker, message);</span>
<span class="nc" id="L424">        column.getChildren().add(row);</span>
<span class="nc" id="L425">    }</span>

    private void flushSegment(List&lt;Segment&gt; segments, StringBuilder buffer, SegmentType currentType) {
<span class="nc bnc" id="L428" title="All 4 branches missed.">        if (currentType != null &amp;&amp; buffer.length() &gt; 0) {</span>
<span class="nc" id="L429">            segments.add(new Segment(buffer.toString(), currentType));</span>
<span class="nc" id="L430">            buffer.setLength(0);</span>
        }
<span class="nc" id="L432">    }</span>

    private void resetColumn(VBox column, String title) {
<span class="nc" id="L435">        column.getChildren().clear();</span>
<span class="nc" id="L436">        column.getChildren().add(createColumnHeader(title));</span>
<span class="nc" id="L437">    }</span>

    private String determineExtension() {
<span class="nc" id="L440">        return viewModel.getCurrentSession()</span>
<span class="nc bnc" id="L441" title="All 6 branches missed.">                .map(session -&gt; switch (session.getLeft().getFormatType()) {</span>
<span class="nc" id="L442">                    case TXT -&gt; &quot;.txt&quot;;</span>
<span class="nc" id="L443">                    case CSV -&gt; &quot;.csv&quot;;</span>
<span class="nc" id="L444">                    case JSON -&gt; &quot;.json&quot;;</span>
<span class="nc" id="L445">                    case XML -&gt; &quot;.xml&quot;;</span>
<span class="nc" id="L446">                    case BIN, HEX -&gt; &quot;.bin&quot;;</span>
<span class="nc" id="L447">                    default -&gt; &quot;&quot;;</span>
<span class="nc" id="L448">                })</span>
<span class="nc" id="L449">                .orElse(&quot;.txt&quot;);</span>
    }

    private void showError(String title, Exception ex) {
<span class="nc" id="L453">        Alert alert = new Alert(Alert.AlertType.ERROR);</span>
<span class="nc" id="L454">        alert.setTitle(title);</span>
<span class="nc" id="L455">        alert.setHeaderText(ex.getMessage());</span>
<span class="nc" id="L456">        alert.setContentText(ex.toString());</span>
<span class="nc" id="L457">        alert.showAndWait();</span>
<span class="nc" id="L458">    }</span>

    private void showInfo(String title, String message) {
<span class="nc" id="L461">        Alert alert = new Alert(Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L462">        alert.setTitle(title);</span>
<span class="nc" id="L463">        alert.setHeaderText(null);</span>
<span class="nc" id="L464">        alert.setContentText(message);</span>
<span class="nc" id="L465">        alert.showAndWait();</span>
<span class="nc" id="L466">    }</span>

    public static void main(String[] args) {
<span class="nc" id="L469">        launch(args);</span>
<span class="nc" id="L470">    }</span>

<span class="nc" id="L472">    private enum SegmentType {</span>
<span class="nc" id="L473">        MATCH,</span>
<span class="nc" id="L474">        DIFF</span>
    }

    private record Segment(String text, SegmentType type) {
    }

    private record TextLine(int number, List&lt;Segment&gt; segments) {
    }

    private record BinaryCell(int index, String hex, char ascii, boolean diff, boolean present) {
    }

    private record BinaryLine(int offset, List&lt;BinaryCell&gt; cells) {
    }
}










</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>